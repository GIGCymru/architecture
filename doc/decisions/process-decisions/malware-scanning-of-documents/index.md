# Malware Scanning for Documents Submitted via APIs

!!! info

    **Status**: Proposed
    
    **Level**: 2

    **Updated**: 2025-12-03

## Summary

This ADR defines how malware scanning will be performed on any documents submitted through platform APIs. The goal is to prevent malicious or unsafe content from entering downstream systems while maintaining a predictable and secure ingestion process. The ADR evaluates architectural approaches to malware scanning and identifies the recommended pattern for the platform.

## Drivers

* APIs accept documents from external sources, creating potential exposure to malware or embedded malicious payloads.
* Downstream systems vary in their capability to perform malware scanning.
* A consistent, platform-wide security assurance model is required.
* Without mandated scanning at the point of submission, risks propagate to internal services and consumers.
* The current platform architecture does not enforce scanning of any uploaded documents.

## Options

### Option 1 — Inline malware scanning in the receiving API

Documents are scanned synchronously as part of the API request. Malicious documents are rejected immediately.

### Option 2 — Asynchronous scanning via event-driven workflow

The API accepts documents and places them in a quarantine state. A background process scans documents asynchronously. Clean documents proceed; infected documents trigger alerts or rejection flows.

### Option 3 — Hybrid malware scanning

Documents undergo a **light synchronous malware check** at submission time to catch obvious threats and provide immediate rejection feedback. All documents then enter an **asynchronous, more detailed scanning process**, which may leverage a dedicated commercial scanning product or service. This ensures comprehensive scanning without blocking the API for extended periods.

## Options Analysis

### Option 1 — Inline malware scanning

**Pro:**

* Ensures no unscanned documents enter the platform boundary.
* Predictable client behaviour: immediate accept/reject.
* Strong alignment with platform security and assurance requirements.

**Con:**

* Adds latency to submission requests.
* Scanner availability is critical to API uptime.
* May require scaling infrastructure for peak load.

**Other:**

* Timeouts and resilience patterns must be designed carefully.

### Option 2 — Asynchronous scanning

**Pro:**

* Faster API responses since scanning is decoupled from submission.
* Scanning service can scale independently.
* Supports advanced scanning techniques (e.g., sandboxing, multi-engine).

**Con:**

* More complex workflow: state management, quarantine handling, event orchestration.
* Clients or downstream consumers must handle “pending” or “failed after acceptance” states.
* Slight delays before documents become available.

**Other:**

* Fits well in platforms already using asynchronous processing models.

### Option 3 — Hybrid malware scanning

**Pro:**

* Provides immediate feedback for obvious malware while allowing detailed scanning without blocking the API.
* Balances security and performance, mitigating the risk of large-latency inline scanning.
* Supports integration with commercial or non-commercial scanning products for comprehensive threat detection.

**Con:**

* More complex architecture: requires both synchronous and asynchronous workflows.
* Downstream systems must handle asynchronous notifications of scanning results.
* Requires coordination and monitoring of two scanning stages.

**Other:**

* Offers a scalable, extensible approach suitable for platforms with high volumes or varied document types.

## Recommendation

**Adopt Option 3: Hybrid malware scanning.**

Hybrid scanning provides the best balance of security, performance, and user experience. A light synchronous check prevents obvious malicious submissions from entering the platform, while asynchronous detailed scanning ensures comprehensive threat detection without blocking API operations. This approach allows integration with commercial scanning services and provides a scalable, future-proof solution.

### Consequences

* **Pro:** Immediate feedback to clients for obviously malicious documents.  
* **Pro:** Comprehensive security coverage through detailed asynchronous scanning.  
* **Pro:** Scalable architecture suitable for high-volume or large documents.  
* **Con:** Increased architectural complexity, requiring orchestration of synchronous and asynchronous processes.  
* **Con:** Downstream systems must handle delayed scanning results and potential rejections.  
* **Other:** Monitoring and alerting are essential to ensure asynchronous scanning completes reliably.

### Confirmation

* Code reviews will verify that all submissions undergo at least the light synchronous check.  
* Automated tests will validate both synchronous rejection behaviour and asynchronous scanning outcomes.  
* Monitoring and alerting will track scanner health, latency, and completion of asynchronous scans.  
* Periodic audits will ensure no unscanned or unsafe documents bypass the process.  
* Metrics will include rejection rates, scanning times, and completion rates for asynchronous scanning.

## More Information

* Revisit this decision if submission volumes increase significantly or if scanning technology evolves.  
* Future ADRs may address sandboxing, multi-engine scanning, risk-based policies, or integration with enterprise security services.
